name: Deploy Websockets Chat App API to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the files
        uses: actions/checkout@v4

      - name: Copy files with SSH
        uses: easingthemes/ssh-deploy@main
        with:
          SSH_PRIVATE_KEY: ${{secrets.EC2_SSH_KEY}}
          ARGS: "-rltgoDzvO --delete -i"
          SOURCE: "./"
          REMOTE_HOST: "${{secrets.REMOTE_HOST}}"
          REMOTE_USER: ${{secrets.REMOTE_USER}}
          TARGET: ${{secrets.TARGET_DIR}}
          EXCLUDE: "/web/, /.vscode/, /.github/"
          SCRIPT_BEFORE: |
            touch .env
            echo "MONGO_HOST=${{secrets.MONGO_HOST}}" >> .env
            echo "MONGO_PORT=${{secrets.MONGO_PORT}}" >> .env
            echo "MONGO_USER=${{secrets.MONGO_USER}}" >> .env
            echo "MONGO_PASS=${{secrets.MONGO_PASS}}" >> .env
            echo "MONGO_DB=${{secrets.MONGO_DB}}" >> .env
            echo "JWT_SECRET=${{secrets.JWT_SECRET}}" >> .env
            whoami
            ls -al
          SCRIPT_AFTER: |
            whoami
            ls -al
            echo $RSYNC_STDOUT
